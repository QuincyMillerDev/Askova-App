graph TD
    subgraph "Next.js Server"
        APIRoutes[API Route Handlers]
        TRPCSetup[tRPC Middleware & Context]
        NextAuthSetup[NextAuth Middleware & Config]
    end

subgraph "tRPC API"
AppRouter[App Router root.ts]
QuizRouter[Quiz Router quiz.ts]
ChatMessageRouter[ChatMessage Router chatMessage.ts]
end

subgraph "Data Layer"
PrismaClient[Prisma Client db.ts]
PostgresDB[PostgreSQL]
end

subgraph "External Services"
GoogleAI[Google Generative AI]
end

subgraph "Configuration"
EnvVars[Environment Variables env.js]
AuthConfig[Auth Config auth/config.ts]
LLMConfig[LLM Config llm/config.ts]
end

%% Request Flow
Client --> APIRoutes

APIRoutes -- /api/auth/... --> NextAuthSetup
APIRoutes -- /api/trpc/... --> TRPCSetup
APIRoutes -- /api/llm-stream --> LLMStreamHandler[LLM Stream Route llm-stream/route.ts]

%% Auth Flow
NextAuthSetup -- Uses --> AuthConfig
NextAuthSetup -- Reads/Writes --> PrismaClient

%% tRPC Flow
TRPCSetup -- Creates Context For --> AppRouter
AppRouter --> QuizRouter
AppRouter --> ChatMessageRouter
QuizRouter -- Uses --> PrismaClient
ChatMessageRouter -- Uses --> PrismaClient

%% LLM Stream Flow
LLMStreamHandler -- Uses --> LLMConfig
LLMStreamHandler -- Calls --> GoogleAI
GoogleAI -- Streams Response --> LLMStreamHandler
LLMStreamHandler -- Streams SSE --> Client

%% Data Persistence
PrismaClient -- Interacts --> PostgresDB

%% Configuration Usage
NextAuthSetup -- Reads --> EnvVars
LLMStreamHandler -- Reads --> EnvVars
PrismaClient -- Reads --> EnvVars
AuthConfig -- Reads --> EnvVars
LLMConfig -- Reads --> EnvVars

style Client fill:#ccf,stroke:#333,stroke-width:2px
style GoogleAI fill:#ffc,stroke:#333,stroke-width:2px
style PostgresDB fill:#fcc,stroke:#333,stroke-width:2px
